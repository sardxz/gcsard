<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trading Tracker ‚Äî Sistema Corrigido</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* === RESET E VARI√ÅVEIS CSS === */
    :root {
      --primary-color: #10b981;
      --primary-dark: #059669;
      --secondary-color: #2563eb;
      --success-color: #16a34a;
      --danger-color: #dc2626;
      --warning-color: #f59e0b;
      --info-color: #3b82f6;
      --light-bg: #f8f9ff;
      --white: #ffffff;
      --gray-100: #f1f5f9;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --border-radius: 8px;
      --border-radius-lg: 12px;
      --transition: all 0.2s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    /* === CONTAINER PRINCIPAL === */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 15px;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      position: relative;
    }

    /* === CABE√áALHO === */
    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: var(--white);
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header h1 { font-size: 2.2em; margin-bottom: 10px; font-weight: 700; }
    .header p { opacity: 0.9; font-size: 1.1em; }

    /* === STATUS E AUTENTICA√á√ÉO === */
    .cloud-status {
      position: absolute; top: 20px; right: 30px; display: flex; align-items: center; gap: 8px;
      background: rgba(255, 255, 255, 0.2); padding: 8px 16px; border-radius: 20px; font-size: 0.9em; backdrop-filter: blur(10px);
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger-color); animation: pulse 2s infinite; }
    .status-dot.online { background: var(--success-color); }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    .auth-bar {
      position: absolute; left: 30px; top: 20px; display: flex; gap: 12px; align-items: center;
      background: rgba(255, 255, 255, 0.1); padding: 8px 16px; border-radius: 20px; backdrop-filter: blur(10px);
    }
    .auth-bar small { opacity: 0.9; font-weight: 500; }

    /* === GRID DE ESTAT√çSTICAS === */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; padding: 30px; background: var(--light-bg); }
    .stat-card {
      background: var(--white); padding: 24px; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md);
      text-align: center; border-left: 5px solid var(--primary-color); transition: var(--transition); position: relative; overflow: hidden;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .stat-card h3 { color: var(--primary-color); font-size: 0.9em; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .stat-card .value { font-size: 1.8em; font-weight: 700; color: var(--gray-900); }

    /* === CONFIGURA√á√ïES === */
    .settings { padding: 28px; background: var(--gray-100); border-bottom: 1px solid var(--gray-200); }
    .settings h2 { color: var(--gray-700); margin-bottom: 20px; font-size: 1.3em; font-weight: 600; }
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }

    /* === CONTROLES === */
    .controls { padding: 28px; background: var(--white); border-bottom: 1px solid var(--gray-200); }
    .controls h2 { color: var(--gray-700); margin-bottom: 20px; font-size: 1.3em; font-weight: 600; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }

    .form-group { display: flex; flex-direction: column; position: relative; }
    .form-group label { margin-bottom: 8px; font-weight: 600; color: var(--gray-700); font-size: 0.9em; }
    .form-group label.required::after { content: ' *'; color: var(--danger-color); font-weight: bold; }
    .form-group input, .form-group select {
      padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: var(--border-radius);
      font-size: 16px; transition: var(--transition); background: var(--white);
    }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
    .form-group input:invalid { border-color: var(--danger-color); }
    .form-group .error-message { color: var(--danger-color); font-size: 0.8em; margin-top: 4px; opacity: 0; transition: var(--transition); }
    .form-group.has-error .error-message { opacity: 1; }
    .form-group.has-error input, .form-group.has-error select { border-color: var(--danger-color); }

    /* === BOT√ïES === */
    .btn {
      padding: 12px 20px; border: none; border-radius: var(--border-radius); font-size: 14px; font-weight: 600; cursor: pointer; transition: var(--transition);
      margin-right: 8px; margin-bottom: 8px; display: inline-flex; align-items: center; gap: 6px; text-decoration: none; position: relative; overflow: hidden;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: var(--white); }
    .btn-success { background: linear-gradient(135deg, var(--secondary-color) 0%, var(--info-color) 100%); color: var(--white); }
    .btn-danger { background: linear-gradient(135deg, var(--danger-color) 0%, #f97316 100%); color: var(--white); }
    .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
    .btn-warning { background: linear-gradient(135deg, var(--warning-color) 0%, #f59e0b 100%); color: var(--white); }

    /* === LOADING STATES === */
    .loading { position: relative; pointer-events: none; }
    .loading::after {
      content: ''; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; margin: -10px 0 0 -10px;
      border: 2px solid transparent; border-top: 2px solid currentColor; border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* === TABELA === */
    .table-container { padding: 28px; overflow-x: auto; position: relative; }
    .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .table-header h2 { color: var(--gray-700); font-size: 1.3em; font-weight: 600; }
    table {
      width: 100%; border-collapse: collapse; background: var(--white); border-radius: var(--border-radius-lg);
      overflow: hidden; box-shadow: var(--shadow-md);
    }
    th {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: var(--white);
      padding: 16px 12px; font-weight: 700; text-align: left; white-space: nowrap; position: sticky; top: 0; z-index: 10;
    }
    td { padding: 16px 12px; border-bottom: 1px solid var(--gray-200); white-space: nowrap; vertical-align: middle; }
    tr:hover { background: var(--light-bg); }
    tr:last-child td { border-bottom: none; }
    .profit { color: var(--success-color); font-weight: 700; }
    .loss { color: var(--danger-color); font-weight: 700; }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--gray-500); }
    .empty-state h3 { font-size: 1.5em; margin-bottom: 12px; color: var(--gray-700); }
    .empty-state p { font-size: 1.1em; margin-bottom: 20px; }

    /* === NOTIFICA√á√ïES === */
    .notification {
      position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: var(--border-radius); color: var(--white); font-weight: 600;
      z-index: 9999; transform: translateX(400px); transition: transform 0.3s ease; max-width: 400px; box-shadow: var(--shadow-lg); backdrop-filter: blur(10px);
    }
    .notification.show { transform: translateX(0); }
    .notification.success { background: linear-gradient(135deg, var(--success-color) 0%, #34d399 100%); }
    .notification.error { background: linear-gradient(135deg, var(--danger-color) 0%, #f97316 100%); }
    .notification.info { background: linear-gradient(135deg, var(--info-color) 0%, #3b82f6 100%); }
    .notification.warning { background: linear-gradient(135deg, var(--warning-color) 0%, #f59e0b 100%); }

    /* === MODAL DE AUTENTICA√á√ÉO === */
    .auth-modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 8000; backdrop-filter: blur(5px); }
    .auth-card {
      background: var(--white); padding: 0; border-radius: var(--border-radius-lg); min-width: 400px; max-width: 500px; box-shadow: var(--shadow-xl);
      overflow: hidden; transform: scale(0.9); transition: transform 0.2s ease;
    }
    .auth-modal.show .auth-card { transform: scale(1); }
    .auth-tabs { display: flex; background: var(--gray-100); }
    .auth-tab { flex: 1; text-align: center; padding: 16px 0; font-weight: 700; cursor: pointer; border-bottom: 3px solid transparent; transition: var(--transition); }
    .auth-tab:hover { background: var(--gray-200); }
    .auth-tab.active { background: var(--white); border-bottom-color: var(--primary-color); }
    .auth-body { padding: 30px; }
    .auth-body h3 { margin-bottom: 20px; color: var(--gray-700); text-align: center; font-size: 1.3em; }
    .auth-row { margin-bottom: 16px; }
    .auth-row input {
      width: 100%; padding: 14px 16px; border: 2px solid var(--gray-200); border-radius: var(--border-radius);
      font-size: 16px; transition: var(--transition);
    }
    .auth-row input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
    .auth-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
    .auth-hint { font-size: 12px; color: var(--gray-500); margin-top: 12px; text-align: center; line-height: 1.4; }

    /* === RESPONSIVIDADE === */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .container { border-radius: 10px; }
      .header { padding: 20px; text-align: left; }
      .header h1 { font-size: 1.6em; }
      .stats-grid, .settings, .controls, .table-container { padding: 20px; }
      .auth-bar { position: relative; left: 0; top: 0; margin-bottom: 12px; justify-content: flex-start; }
      .cloud-status { position: relative; top: 0; right: 0; margin-top: 12px; justify-content: flex-start; }
      .auth-card { min-width: 320px; margin: 20px; }
      .form-grid, .settings-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .table-container { padding: 15px; }
      table { font-size: 14px; }
      th, td { padding: 12px 8px; }
    }

    /* === ACESSIBILIDADE === */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
    }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    .btn:focus-visible, input:focus-visible, select:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; }
  </style>
</head>
<body>
  <!-- === CONTAINER PRINCIPAL === -->
  <div class="container">
    <!-- === CABE√áALHO COM AUTENTICA√á√ÉO E STATUS === -->
    <div class="header">
      <div class="auth-bar">
        <small id="whoami" aria-label="Status do usu√°rio">Carregando...</small>
        <button class="btn btn-secondary" id="btnLogin" aria-label="Fazer login"><span>üîê</span> Entrar</button>
        <button class="btn btn-secondary" id="btnLogout" style="display:none" aria-label="Fazer logout"><span>üö™</span> Sair</button>
      </div>

      <div class="cloud-status" role="status" aria-live="polite">
        <div class="status-dot" id="statusDot" aria-hidden="true"></div>
        <span id="cloudStatus">Conectando...</span>
      </div>

      <h1>üìà Trading Tracker</h1>
      <p>Sistema Avan√ßado de Rastreamento de Trades</p>
    </div>

    <!-- === SE√á√ÉO DE CONFIGURA√á√ïES GERAIS === -->
    <div class="settings">
      <h2>‚öôÔ∏è Configura√ß√µes da Conta</h2>
      <div class="settings-grid">
        <div class="form-group">
          <label for="bankInitial" class="required">Banca Inicial (USDT)</label>
          <input type="number" id="bankInitial" step="0.01" placeholder="ex: 59000" required />
          <div class="error-message" id="bankInitial-error"></div>
          <small>Valor total da sua banca para trading</small>
        </div>

        <div class="form-group">
          <label for="initialTrade" class="required">Valor 1¬∫ Trade (USDT)</label>
          <input type="number" id="initialTrade" step="0.01" placeholder="ex: 2360" required />
          <div class="error-message" id="initialTrade-error"></div>
          <small>Valor do primeiro trade da sua estrat√©gia</small>
        </div>

        <div class="form-group">
          <label for="percentTarget" class="required">Percentual Alvo por Trade (%)</label>
          <input type="number" id="percentTarget" step="0.01" placeholder="ex: 12" required />
          <div class="error-message" id="percentTarget-error"></div>
          <small>Meta de lucro/preju√≠zo por opera√ß√£o</small>
        </div>

        <div style="display:flex;align-items:flex-end;gap:12px">
          <button class="btn btn-success" id="saveSettings" aria-label="Salvar configura√ß√µes"><span>üíæ</span> Salvar Configura√ß√µes</button>
        </div>
      </div>
    </div>

    <!-- === GRID DE ESTAT√çSTICAS E M√âTRICAS === -->
    <div class="stats-grid">
      <div class="stat-card"><h3>Banca Total</h3><div class="value" id="totalBalance">$0.00</div></div>
      <div class="stat-card"><h3>Pr√≥ximo Trade</h3><div class="value" id="nextTradeValue">$0.00</div></div>
      <div class="stat-card"><h3>Total de Trades</h3><div class="value" id="totalTrades">0</div></div>
      <div class="stat-card"><h3>Win Rate</h3><div class="value" id="winRate">0%</div></div>
      <div class="stat-card"><h3>Lucro Acumulado</h3><div class="value profit" id="totalProfit">$0.00</div></div>
      <div class="stat-card"><h3>ROI (sobre banca)</h3><div class="value" id="totalROI">0%</div></div>
    </div>

    <!-- === CONTROLES PARA ADICIONAR TRADES === -->
    <div class="controls">
      <h2>üìù Registrar Novo Trade</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="tradeDate" class="required">Data do Trade</label>
          <input type="date" id="tradeDate" required />
          <div class="error-message" id="tradeDate-error"></div>
        </div>

        <div class="form-group">
          <label for="pair" class="required">Paridade</label>
          <input type="text" id="pair" placeholder="ex: BTCUSDT" required />
          <div class="error-message" id="pair-error"></div>
        </div>

        <div class="form-group">
          <label for="tradeValue">Valor do Trade (calculado)</label>
          <input type="number" id="tradeValue" step="0.01" readonly />
        </div>

        <div class="form-group">
          <label for="position" class="required">Tipo de Posi√ß√£o</label>
          <select id="position" required>
            <option value="">Selecione...</option>
            <option value="long">LONG (Compra)</option>
            <option value="short">SHORT (Venda)</option>
          </select>
          <div class="error-message" id="position-error"></div>
        </div>

        <div class="form-group">
          <label for="resultType" class="required">Resultado</label>
          <select id="resultType" required>
            <option value="">Selecione...</option>
            <option value="profit">Lucro</option>
            <option value="loss">Preju√≠zo</option>
          </select>
          <div class="error-message" id="resultType-error"></div>
        </div>

        <div class="form-group">
          <label for="percentage" class="required">Percentual (%)</label>
          <input type="number" id="percentage" step="0.01" required min="0" max="100" />
          <div class="error-message" id="percentage-error"></div>
        </div>

        <div class="form-group">
          <label for="observations">Observa√ß√µes</label>
          <input type="text" id="observations" placeholder="Setup, estrat√©gia, etc." maxlength="200" />
        </div>
      </div>

      <div>
        <button class="btn btn-primary" id="addTradeBtn"><span>‚ûï</span> Adicionar Trade</button>
        <button class="btn btn-success" id="exportBtn"><span>üìä</span> Exportar CSV</button>
        <button class="btn btn-danger" id="resetBtn"><span>‚ôªÔ∏è</span> Resetar Tudo</button>
      </div>
    </div>

    <!-- === SE√á√ÉO DA TABELA DE TRADES === -->
    <div class="table-container">
      <div class="table-header"><h2>üìã Hist√≥rico de Trades</h2></div>
      <div class="table-wrapper">
        <table id="tradesTable">
          <thead>
            <tr>
              <th>Data</th><th>Paridade</th><th>Valor Trade</th><th>Tipo</th><th>Resultado</th><th>PNL (%)</th><th>PNL ($)</th><th>Novo Valor</th><th>Observa√ß√µes</th><th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tradesBody"></tbody>
        </table>

        <div class="empty-state" id="emptyState" style="display: none;">
          <h3>üìà Nenhum trade registrado</h3>
          <p>Adicione seu primeiro trade para come√ßar a acompanhar sua performance!</p>
          <button class="btn btn-primary" onclick="document.getElementById('tradeDate').focus()"><span>‚ûï</span> Adicionar Primeiro Trade</button>
        </div>
      </div>
    </div>
  </div>

  <!-- === MODAL DE AUTENTICA√á√ÉO === -->
  <div class="auth-modal" id="authModal">
    <div class="auth-card">
      <div class="auth-tabs">
        <div class="auth-tab active" id="tabSignup">CADASTRO</div>
        <div class="auth-tab" id="tabLogin">LOGIN</div>
      </div>

      <!-- Painel de Cadastro -->
      <div class="auth-body" id="bodySignup">
        <h3>Criar Nova Conta</h3>
        <div class="auth-row"><input type="email" id="signupEmail" placeholder="seu@email.com" required /></div>
        <div class="auth-row"><input type="text" id="signupUsername" placeholder="nome_de_usuario" required /></div>
        <div class="auth-row"><input type="password" id="signupPassword" placeholder="senha segura" required /></div>
        <div class="auth-actions">
          <button class="btn btn-secondary" id="closeAuth1">Cancelar</button>
          <button class="btn btn-primary" id="doSignup"><span>üöÄ</span> Cadastrar</button>
        </div>
        <div class="auth-hint">
          O <strong>nome de usu√°rio</strong> ser√° usado para fazer login.<br>
          Use letras, n√∫meros e underscore (3‚Äì20 caracteres).
        </div>
      </div>

      <!-- Painel de Login -->
      <div class="auth-body" id="bodyLogin" style="display:none">
        <h3>Entrar na Conta</h3>
        <div class="auth-row"><input type="text" id="loginUsername" placeholder="seu_nome_de_usuario" required /></div>
        <div class="auth-row"><input type="password" id="loginPassword" placeholder="sua senha" required /></div>
        <div class="auth-actions">
          <button class="btn btn-secondary" id="closeAuth2">Cancelar</button>
          <button class="btn btn-primary" id="doLogin"><span>üîê</span> Entrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- === SCRIPTS === -->
  <script>
    // ======= CREDENCIAIS DO SUPABASE =======
    const SUPABASE_URL = 'https://jxndphnwylymamgedoyq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4bmRwaG53eWx5bWFtZ2Vkb3lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNTk5NjksImV4cCI6MjA3MTYzNTk2OX0.tjOi-P6x9jN3sgIeKZU6zzEhwtF0FCuedeOnYvaEcp0';
    // ======================================

    class TradingTracker {
      constructor() {
        this.sb = null;
        this.state = {
          user: null,
          trades: [],
          initialBalance: 0,
          initialTradeValue: 0,
          percentTarget: 0,
          currentTradeValue: 0,
          profileUsername: '',
          isLoading: false
        };
        this.debounceTimers = {};
        this.init();
      }

      // === INICIALIZA√á√ÉO ===
      async init() {
        try {
          if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            this.showNotification('Configure as credenciais do Supabase no c√≥digo!', 'error');
            this.setConnectionStatus(false);
            return;
          }

          // Client do CDN
          this.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

          this.setupEventListeners();
          this.setupAuthListeners();
          await this.initSession();
          this.setDefaultDate();
        } catch (error) {
          console.error('‚ùå Erro na inicializa√ß√£o:', error);
          this.showNotification('Erro na inicializa√ß√£o: ' + error.message, 'error');
          this.setConnectionStatus(false);
        }
      }

      // === EVENTOS DE UI (robustos) ===
      setupEventListeners() {
        const on = (id, fn) => { const el = document.getElementById(id); if (el) el.onclick = fn; };

        // Autentica√ß√£o
        on('btnLogin', () => this.openAuthModal('login'));
        on('btnLogout', () => this.logout());
        on('closeAuth1', () => this.closeAuthModal());
        on('closeAuth2', () => this.closeAuthModal());
        on('doSignup', () => this.signup());
        on('doLogin', () => this.login());

        // Abas do modal
        on('tabSignup', () => this.switchAuthTab('signup'));
        on('tabLogin', () => this.switchAuthTab('login'));

        // Configura√ß√µes e trades
        on('saveSettings', () => this.saveSettings());
        on('addTradeBtn', () => this.addTrade());
        on('exportBtn', () => this.exportCSV());
        on('resetBtn', () => this.resetAll());

        // Fechar modal ao clicar fora
        const modal = document.getElementById('authModal');
        if (modal) modal.onclick = (e) => { if (e.target === e.currentTarget) this.closeAuthModal(); };

        // ESC para fechar modal
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') this.closeAuthModal(); });
      }

      // === LISTENERS DE AUTH ===
      setupAuthListeners() {
        this.sb.auth.onAuthStateChange(async (event, session) => {
          try {
            if (event === 'SIGNED_IN' && session?.user) {
              this.state.user = session.user;
              await this.loadEverything();
              this.toggleAuth(true);
              this.showNotification('Login realizado com sucesso!', 'success');
            } else if (event === 'SIGNED_OUT') {
              this.handleSignOut();
            } else if (event === 'TOKEN_REFRESHED') {
              console.log('üîÑ Token atualizado');
            }
          } catch (error) {
            console.error('Erro no listener de auth:', error);
            this.showNotification('Erro na autentica√ß√£o: ' + error.message, 'error');
          }
        });
      }

      // === SESS√ÉO ===
      async initSession() {
        this.setLoadingState(true);
        try {
          const { data: { session }, error } = await this.sb.auth.getSession();
          if (error) {
            console.error('Erro ao obter sess√£o:', error);
            this.setConnectionStatus(false);
            this.setWhoAmI('Deslogado');
            return;
          }

          this.state.user = session?.user || null;

          if (this.state.user) {
            await this.loadEverything();
            this.toggleAuth(true);
          } else {
            this.toggleAuth(false);
            this.setDefaultValues();
          }

          this.setConnectionStatus(!!this.state.user);
        } catch (error) {
          console.error('Erro na inicializa√ß√£o da sess√£o:', error);
          this.showNotification('Erro na conex√£o com o servidor', 'error');
          this.setConnectionStatus(false);
          this.setWhoAmI('Erro na conex√£o');
        } finally {
          this.setLoadingState(false);
        }
      }

      // === CARREGAR DADOS ===
      async loadEverything() {
        if (!this.state.user) return;
        this.setLoadingState(true);
        try {
          const profile = await this.ensureProfile();

          this.state.initialBalance = Number(profile.bank_initial || 0);
          this.state.initialTradeValue = Number(profile.initial_trade_value || 0);
          this.state.percentTarget = Number(profile.percent_target || 0);
          this.state.profileUsername = profile.username || '';

          this.setWhoAmI(this.state.profileUsername || this.state.user?.email || 'Usu√°rio');

          document.getElementById('bankInitial').value = this.state.initialBalance || '';
          document.getElementById('initialTrade').value = this.state.initialTradeValue || '';
          document.getElementById('percentTarget').value = this.state.percentTarget || '';

          await this.loadTradesWithRetry();
          this.updateCurrentTradeValue();

          document.getElementById('percentage').value = this.state.percentTarget || 12;
          document.getElementById('tradeValue').value = (this.state.currentTradeValue || 0).toFixed(2);

          this.render();
        } catch (error) {
          console.error('Erro ao carregar dados:', error);
          this.showNotification('Erro ao carregar dados: ' + error.message, 'error');
        } finally {
          this.setLoadingState(false);
        }
      }

      async loadTradesWithRetry(maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            const { data: trades, error } = await this.sb
              .from('trades')
              .select('*')
              .eq('user_id', this.state.user.id)
              .order('trade_date', { ascending: true });

            if (error) throw error;

            this.state.trades = trades || [];
            return;
          } catch (error) {
            console.error(`Tentativa ${attempt} ao buscar trades falhou:`, error);
            if (attempt === maxRetries) {
              this.state.trades = [];
              this.showNotification('N√£o foi poss√≠vel carregar os trades. Recarregue a p√°gina.', 'error');
            } else {
              await new Promise(r => setTimeout(r, 1000 * attempt));
            }
          }
        }
      }

      // === PERFIL (cria se n√£o existir) ===
      async ensureProfile() {
        try {
          const { data: profile, error } = await this.sb
            .from('profiles')
            .select('*')
            .eq('id', this.state.user.id)
            .single();

          // PGRST116 = no rows
          if (error && error.code === 'PGRST116') {
            const defaultProfile = {
              id: this.state.user.id,
              email: this.state.user.email || null,
              username: null,
              bank_initial: 59000,
              initial_trade_value: 2360,
              percent_target: 12
            };
            const { data: newProfile, error: createError } = await this.sb
              .from('profiles')
              .insert(defaultProfile)
              .select()
              .single();
            if (createError) throw createError;
            return newProfile;
          }
          if (error) throw error;
          return profile;
        } catch (error) {
          console.error('Erro no perfil:', error);
          return {
            id: this.state.user.id,
            email: this.state.user.email || null,
            username: null,
            bank_initial: 59000,
            initial_trade_value: 2360,
            percent_target: 12
          };
        }
      }

      // === LOGOUT ===
      async logout() {
        if (!confirm('Deseja realmente sair da sua conta?')) return;
        this.setLoadingState(true);
        try {
          const { error } = await this.sb.auth.signOut();
          if (error) throw error;
        } catch (error) {
          console.error('Erro no logout:', error);
          this.showNotification('Erro ao fazer logout: ' + error.message, 'error');
          this.handleSignOut();
        } finally {
          this.setLoadingState(false);
        }
      }

      handleSignOut() {
        this.state.user = null;
        this.state.trades = [];
        this.state.profileUsername = '';
        this.toggleAuth(false);
        this.setDefaultValues();
        this.render();
        this.showNotification('Logout realizado', 'info');
      }

      // === LOADING ===
      setLoadingState(isLoading) {
        this.state.isLoading = isLoading;
        document.querySelectorAll('.btn').forEach(btn => {
          if (isLoading) { btn.classList.add('loading'); btn.disabled = true; }
          else { btn.classList.remove('loading'); btn.disabled = false; }
        });
      }

      // === UI AUTH ===
      toggleAuth(isLogged) {
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        btnLogin.style.display = isLogged ? 'none' : 'inline-flex';
        btnLogout.style.display = isLogged ? 'inline-flex' : 'none';
        this.setWhoAmI(isLogged ? (this.state.profileUsername || this.state.user?.email || 'Usu√°rio') : 'Deslogado');
        this.setConnectionStatus(isLogged);
      }
      setWhoAmI(name) { document.getElementById('whoami').textContent = name || 'Deslogado'; }
      setConnectionStatus(online) {
        const dot = document.getElementById('statusDot');
        const txt = document.getElementById('cloudStatus');
        if (online) { dot.classList.add('online'); txt.textContent = 'Online'; }
        else { dot.classList.remove('online'); txt.textContent = 'Offline'; }
      }

      // === MODAL ===
      openAuthModal(tab = 'login') {
        this.switchAuthTab(tab);
        const modal = document.getElementById('authModal');
        modal.style.display = 'flex';
        modal.classList.add('show');
        setTimeout(() => { const first = modal.querySelector('input'); if (first) first.focus(); }, 100);
      }
      closeAuthModal() {
        const modal = document.getElementById('authModal');
        modal.classList.remove('show');
        setTimeout(() => { modal.style.display = 'none'; this.clearAuthForms(); }, 200);
      }
      switchAuthTab(tab) {
        const tabSignup = document.getElementById('tabSignup');
        const tabLogin = document.getElementById('tabLogin');
        const bodySignup = document.getElementById('bodySignup');
        const bodyLogin  = document.getElementById('bodyLogin');
        if (tab === 'signup') {
          tabSignup.classList.add('active'); tabLogin.classList.remove('active');
          bodySignup.style.display = 'block'; bodyLogin.style.display = 'none';
        } else {
          tabLogin.classList.add('active'); tabSignup.classList.remove('active');
          bodyLogin.style.display = 'block'; bodySignup.style.display = 'none';
        }
      }
      clearAuthForms() {
        ['signupEmail','signupUsername','signupPassword','loginUsername','loginPassword'].forEach(id => {
          const el = document.getElementById(id); if (el) el.value = '';
        });
      }

      // === CADASTRO ===
      async signup() {
        const email = document.getElementById('signupEmail').value.trim();
        const username = document.getElementById('signupUsername').value.trim();
        const password = document.getElementById('signupPassword').value.trim();

        if (!email || !username || !password) { this.showNotification('Preencha todos os campos', 'error'); return; }
        if (password.length < 6) { this.showNotification('Senha deve ter pelo menos 6 caracteres', 'error'); return; }

        this.setLoadingState(true);
        try {
          const { data: signUpData, error: signUpError } = await this.sb.auth.signUp({ email, password });
          if (signUpError) throw signUpError;

          const authUserId = signUpData.user?.id;
          if (authUserId) {
            const { error: profileError } = await this.sb.from('profiles').insert({
              id: authUserId, email, username, bank_initial: 59000, initial_trade_value: 2360, percent_target: 12
            });
            if (profileError && !String(profileError.message).includes('duplicate')) console.error('Erro no perfil:', profileError);
          }

          // Tentar login autom√°tico (se n√£o exigir confirma√ß√£o de email)
          const { error: loginError } = await this.sb.auth.signInWithPassword({ email, password });
          if (loginError) {
            this.showNotification('Conta criada! Fa√ßa login agora.', 'success');
            this.switchAuthTab('login');
          } else {
            this.closeAuthModal();
            this.showNotification('Cadastro e login realizados!', 'success');
          }
        } catch (error) {
          console.error('Erro no cadastro:', error);
          this.showNotification(this.getErrorMessage(error), 'error');
        } finally { this.setLoadingState(false); }
      }

      // === LOGIN (usu√°rio + senha) ===
      async login() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value.trim();

        if (!username || !password) { this.showNotification('Preencha usu√°rio e senha', 'error'); return; }

        this.setLoadingState(true);
        try {
          let email = null;

          try {
            // RPC: converte username -> email
            const { data: rpcData, error: rpcError } = await this.sb.rpc('get_email_by_username', { p_username: username });
            if (rpcError) throw rpcError;
            email = rpcData;
          } catch (rpcError) {
            // Fallback: se usu√°rio digitou um e-mail
            if (username.includes('@')) email = username;
            else {
              this.showNotification('Fun√ß√£o de busca n√£o configurada. Use e-mail para login.', 'error');
              return;
            }
          }

          if (!email) { this.showNotification('Usu√°rio n√£o encontrado', 'error'); return; }

          const { error: loginError } = await this.sb.auth.signInWithPassword({ email, password });
          if (loginError) throw loginError;

          this.closeAuthModal();
        } catch (error) {
          console.error('Erro no login:', error);
          this.showNotification(this.getErrorMessage(error), 'error');
        } finally { this.setLoadingState(false); }
      }

      // === SALVAR CONFIGURA√á√ïES ===
      async saveSettings() {
        if (!this.state.user) { this.showNotification('Fa√ßa login para salvar', 'error'); return; }

        const bank = Number(document.getElementById('bankInitial').value || 0);
        const initValue = Number(document.getElementById('initialTrade').value || 0);
        const percent = Number(document.getElementById('percentTarget').value || 0);

        if (bank <= 0 || initValue <= 0 || percent <= 0) { this.showNotification('Valores devem ser maiores que zero', 'error'); return; }

        this.setLoadingState(true);
        try {
          const { error } = await this.sb.from('profiles').upsert({
            id: this.state.user.id, bank_initial: bank, initial_trade_value: initValue, percent_target: percent
          });
          if (error) throw error;

          this.state.initialBalance = bank;
          this.state.initialTradeValue = initValue;
          this.state.percentTarget = percent;

          if (this.state.trades.length === 0) {
            this.state.currentTradeValue = this.state.initialTradeValue;
            document.getElementById('tradeValue').value = this.state.currentTradeValue.toFixed(2);
          }

          this.render();
          this.showNotification('Configura√ß√µes salvas!', 'success');
        } catch (error) {
          console.error('Erro ao salvar:', error);
          this.showNotification('Erro ao salvar: ' + error.message, 'error');
        } finally { this.setLoadingState(false); }
      }

      // === ADICIONAR TRADE ===
      async addTrade() {
        if (!this.state.user) { this.showNotification('Fa√ßa login para adicionar trades', 'error'); return; }

        const date = document.getElementById('tradeDate').value;
        const pair = document.getElementById('pair').value.trim().toUpperCase();
        const value = Number(document.getElementById('tradeValue').value);
        const position = document.getElementById('position').value;
        const type = document.getElementById('resultType').value;
        const percent = Number(document.getElementById('percentage').value);
        const observations = document.getElementById('observations').value.trim();

        if (!date || !pair || !position || !type || !percent) { this.showNotification('Preencha todos os campos obrigat√≥rios', 'error'); return; }
        if (percent <= 0) { this.showNotification('Percentual deve ser maior que zero', 'error'); return; }

        this.setLoadingState(true);
        try {
          const resultAbs = +(value * (percent / 100)).toFixed(2);
          const result = type === 'profit' ? resultAbs : -resultAbs;
          const newValue = +(value + result).toFixed(2);

          const payload = {
            user_id: this.state.user.id, trade_date: date, pair, position,
            value_trade: value, type, percent, result, new_value: newValue, observations
          };

          const { data, error } = await this.sb.from('trades').insert(payload).select().single();
          if (error) throw error;

          this.state.trades.push(data);
          this.state.currentTradeValue = newValue;
          document.getElementById('tradeValue').value = newValue.toFixed(2);

          this.clearTradeForm();
          this.render();
          this.showNotification('Trade adicionado!', 'success');
        } catch (error) {
          console.error('Erro ao adicionar trade:', error);
          this.showNotification('Erro ao adicionar trade: ' + error.message, 'error');
        } finally { this.setLoadingState(false); }
      }

      updateCurrentTradeValue() {
        if (this.state.trades.length > 0) {
          const lastTrade = this.state.trades[this.state.trades.length - 1];
          this.state.currentTradeValue = Number(lastTrade.new_value);
        } else {
          this.state.currentTradeValue = this.state.initialTradeValue;
        }
      }

      clearTradeForm() {
        document.getElementById('pair').value = '';
        document.getElementById('position').value = '';
        document.getElementById('resultType').value = '';
        document.getElementById('percentage').value = this.state.percentTarget || 12;
        document.getElementById('observations').value = '';
      }

      async removeTrade(tradeId) {
        if (!confirm('Remover este trade?')) return;
        this.setLoadingState(true);
        try {
          const { error } = await this.sb.from('trades').delete().eq('id', tradeId).eq('user_id', this.state.user.id);
          if (error) throw error;

          this.state.trades = this.state.trades.filter(t => t.id !== tradeId);
          this.updateCurrentTradeValue();
          document.getElementById('tradeValue').value = (this.state.currentTradeValue || 0).toFixed(2);
          this.render();
          this.showNotification('Trade removido', 'success');
        } catch (error) {
          console.error('Erro ao remover:', error);
          this.showNotification('Erro ao remover trade', 'error');
        } finally { this.setLoadingState(false); }
      }

      // === EXPORTAR CSV ===
      exportCSV() {
        if (this.state.trades.length === 0) { this.showNotification('Nenhum trade para exportar', 'warning'); return; }
        try {
          const headers = ['Data','Paridade','Valor Trade','Tipo','Resultado','PNL (%)','PNL ($)','Novo Valor','Observa√ß√µes'];
          const rows = this.state.trades.map(trade => {
            const signedPct = (trade.type === 'loss' ? -Number(trade.percent || 0) : Number(trade.percent || 0));
            return [
              trade.trade_date, trade.pair || '', trade.value_trade, (trade.position || '').toUpperCase(),
              trade.type === 'profit' ? 'Lucro' : 'Preju√≠zo', `${signedPct}%`, trade.result, trade.new_value,
              `"${(trade.observations || '').replace(/"/g, '""')}"`
            ];
          });
          const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a'); link.href = url; link.download = `trades_${new Date().toISOString().slice(0,10)}.csv`;
          document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
          this.showNotification('Dados exportados!', 'success');
        } catch (error) {
          console.error('Erro na exporta√ß√£o:', error);
          this.showNotification('Erro ao exportar dados', 'error');
        }
      }

      // === RESETAR DADOS ===
      async resetAll() {
        if (!this.state.user) { this.showNotification('Fa√ßa login para resetar', 'error'); return; }
        if (!confirm('ATEN√á√ÉO: Isso apagar√° TODOS os seus trades permanentemente!\n\nDeseja continuar?')) return;

        this.setLoadingState(true);
        try {
          const { error } = await this.sb.from('trades').delete().eq('user_id', this.state.user.id);
          if (error) throw error;

          this.state.trades = [];
          this.state.currentTradeValue = this.state.initialTradeValue;
          document.getElementById('tradeValue').value = this.state.currentTradeValue.toFixed(2);
          this.render();
          this.showNotification('Todos os dados foram apagados', 'success');
        } catch (error) {
          console.error('Erro ao resetar:', error);
          this.showNotification('Erro ao resetar dados', 'error');
        } finally { this.setLoadingState(false); }
      }

      // === RENDER ===
      render() {
        const stats = this.calculateStats();
        document.getElementById('totalTrades').textContent = stats.totalTrades;
        document.getElementById('winRate').textContent = this.formatPercent(stats.winRate);
        document.getElementById('totalProfit').textContent = this.formatMoney(stats.totalProfit);
        document.getElementById('totalROI').textContent = this.formatPercent(stats.totalROI);
        document.getElementById('nextTradeValue').textContent = this.formatMoney(stats.nextTradeValue);
        document.getElementById('totalBalance').textContent = this.formatMoney(stats.totalBalance);
        this.renderTable();
      }

      renderTable() {
        const tbody = document.getElementById('tradesBody');
        const emptyState = document.getElementById('emptyState');

        if (this.state.trades.length === 0) {
          tbody.innerHTML = '';
          emptyState.style.display = 'block';
          return;
        }

        emptyState.style.display = 'none';
        tbody.innerHTML = '';

        this.state.trades.forEach(trade => {
          const tr = document.createElement('tr');
          const signedPct = trade.type === 'loss' ? -Number(trade.percent || 0) : Number(trade.percent || 0);
          const resultClass = trade.type === 'profit' ? 'profit' : 'loss';

          tr.innerHTML = `
            <td>${this.formatDate(trade.trade_date)}</td>
            <td><strong>${trade.pair || ''}</strong></td>
            <td>${this.formatMoney(trade.value_trade)}</td>
            <td>${(trade.position || '').toUpperCase()}</td>
            <td><span class="${resultClass}">${trade.type === 'profit' ? 'Lucro' : 'Preju√≠zo'}</span></td>
            <td><strong>${signedPct.toFixed(2)}%</strong></td>
            <td class="${resultClass}"><strong>${this.formatMoney(trade.result)}</strong></td>
            <td>${this.formatMoney(trade.new_value)}</td>
            <td>${trade.observations || ''}</td>
            <td><button class="btn btn-danger" onclick="app.removeTrade(${trade.id})" title="Remover trade">üóëÔ∏è</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      // === ESTAT√çSTICAS ===
      calculateStats() {
        const total = this.state.trades.length;
        if (total === 0) {
          return {
            totalTrades: 0,
            winRate: 0,
            totalProfit: 0,
            totalROI: 0,
            totalBalance: this.state.initialBalance,
            nextTradeValue: this.state.initialTradeValue
          };
        }
        const wins = this.state.trades.filter(t => t.type === 'profit').length;
        const winRate = (wins / total) * 100;
        const totalProfit = this.state.trades.reduce((sum, t) => sum + (t.result || 0), 0);
        const totalROI = this.state.initialBalance > 0 ? (totalProfit / this.state.initialBalance) * 100 : 0;
        const totalBalance = this.state.initialBalance - this.state.initialTradeValue + this.state.currentTradeValue + totalProfit;

        return {
          totalTrades: total,
          winRate,
          totalProfit,
          totalROI,
          totalBalance,
          nextTradeValue: this.state.currentTradeValue
        };
      }

      // === UTILIT√ÅRIOS ===
      formatMoney(value) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value || 0);
      }
      formatDate(dateString) { return new Date(dateString).toLocaleDateString('pt-BR'); }
      formatPercent(value, decimals = 1) { return `${Number(value || 0).toFixed(decimals)}%`; }

      // === NOTIFICA√á√ïES ===
      showNotification(message, type = 'success', duration = 4000) {
        document.querySelectorAll(`.notification.${type}`).forEach(n => n.remove());
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:1.1em;">${this.getNotificationIcon(type)}</span>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:white;cursor:pointer;font-size:1.2em;margin-left:auto;">‚úï</button>
          </div>`;
        document.body.appendChild(notification);
        setTimeout(() => notification.classList.add('show'), 50);
        setTimeout(() => { notification.classList.remove('show'); setTimeout(() => notification.remove(), 300); }, duration);
      }
      getNotificationIcon(type) { return ({ success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è' }[type] || '‚ÑπÔ∏è'); }

      getErrorMessage(error) {
        const map = {
          'Invalid login credentials': 'Credenciais inv√°lidas. Verifique usu√°rio e senha.',
          'Email not confirmed': 'Confirme seu e-mail antes de fazer login.',
          'Too many requests': 'Muitas tentativas. Tente novamente em alguns minutos.',
          'User already registered': 'E-mail j√° cadastrado. Fa√ßa login ou use outro e-mail.',
          'Password should be at least 6 characters': 'Senha deve ter pelo menos 6 caracteres.',
          'Unable to validate email address': 'E-mail inv√°lido.',
          'signup_disabled': 'Cadastro de novos usu√°rios desabilitado.'
        };
        return map[error.message] || error.message || 'Erro desconhecido';
      }

      // === VALORES PADR√ÉO ===
      setDefaultDate() { const today = new Date().toISOString().slice(0, 10); document.getElementById('tradeDate').value = today; }
      setDefaultValues() { this.setDefaultDate(); document.getElementById('percentage').value = 12; document.getElementById('tradeValue').value = '0.00'; }
    }

    // === INICIALIZA√á√ÉO GLOBAL ===
    let app;
    document.addEventListener('DOMContentLoaded', () => { app = new TradingTracker(); });

    // Wrapper opcional (caso queira usar removeTrade no HTML sem app.)
    window.removeTrade = (tradeId) => { if (app) app.removeTrade(tradeId); };

    // === ERROS GLOBAIS & CONECTIVIDADE ===
    window.addEventListener('error', (event) => { console.error('Erro global:', event.error); if (app) app.showNotification('Erro inesperado na aplica√ß√£o', 'error'); });
    window.addEventListener('unhandledrejection', (event) => { console.error('Promise rejeitada:', event.reason); if (app) app.showNotification('Erro de conex√£o. Verifique sua internet.', 'error'); });
    window.addEventListener('online', () => { if (app) { app.showNotification('Conex√£o restabelecida', 'success'); if (app.state.user) app.loadEverything(); } });
    window.addEventListener('offline', () => { if (app) { app.showNotification('Sem conex√£o com a internet', 'warning'); app.setConnectionStatus(false); } });
    document.addEventListener('visibilitychange', () => { if (!document.hidden && app && app.state.user) setTimeout(() => app.initSession(), 500); });
  </script>
<script>
/* ==== DIAGN√ìSTICO VISUAL ‚Äì sem DevTools ==== */
(function setupQuickDiag(){
  function mountPanel(){
    const box = document.createElement('div');
    box.id = 'diagBox';
    box.style.cssText = 'position:fixed;bottom:14px;left:14px;max-width:48vw;max-height:50vh;overflow:auto;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:12px 12px 4px;font:12px/1.35 monospace;z-index:99999;box-shadow:0 10px 30px rgba(0,0,0,.35)';
    box.innerHTML = '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><strong style="font:600 12px Inter,system-ui">Diagn√≥stico Supabase</strong><span id="diagStatus" style="opacity:.8"></span><button id="diagClose" style="margin-left:auto;background:#334155;border:none;color:#fff;padding:4px 8px;border-radius:6px;cursor:pointer">Fechar</button></div><pre id="diagOut" style="white-space:pre-wrap;margin:0"></pre>';
    document.body.appendChild(box);
    document.getElementById('diagClose').onclick=()=>box.remove();
    return {box, out: document.getElementById('diagOut'), status: document.getElementById('diagStatus')};
  }
  function log(p, ...args){
    const line = args.map(a => (typeof a==='object' ? JSON.stringify(a, null, 2) : String(a))).join(' ');
    p.out.textContent += line + '\n';
  }
  async function run(){
    const p = mountPanel();
    const sb = (window.app && app.sb) ? app.sb : window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    p.status.textContent = ' (executando...)';
    try {
      const { data:{ session }, error:sErr } = await sb.auth.getSession();
      log(p, 'getSession.error:', sErr || null);
      log(p, 'session:', session ? { id: session.user.id, email: session.user.email } : null);
      if (!session) { log(p, '\n‚ö†Ô∏è N√£o logado. Clique em Entrar e rode o diagn√≥stico de novo.'); p.status.textContent = ' pronto'; return; }

      const uid = session.user.id;

      // 1) SELECT profile
      const profSel = await sb.from('profiles').select('*').eq('id', uid).single();
      log(p, '\nprofiles SELECT -> status:', profSel.status || null);
      log(p, 'profiles.error:', profSel.error || null);
      log(p, 'profiles.data:', profSel.data || null);

      // Se n√£o existe (PGRST116), tenta criar um perfil padr√£o
      if (profSel.error && profSel.error.code === 'PGRST116') {
        const profIns = await sb.from('profiles').insert({
          id: uid,
          email: session.user.email,
          username: (session.user.email || '').split('@')[0],
          bank_initial: 60000,
          initial_trade_value: 2000,
          percent_target: 10
        }).select().single();
        log(p, '\nprofiles INSERT -> status:', profIns.status || null);
        log(p, 'profiles.insert.error:', profIns.error || null);
        log(p, 'profiles.insert.data:', profIns.data || null);
      }

      // 2) SELECT trades
      const tSel = await sb.from('trades').select('id').eq('user_id', uid).limit(1);
      log(p, '\ntrades SELECT -> status:', tSel.status || null);
      log(p, 'trades.select.error:', tSel.error || null);
      log(p, 'trades.select.data:', tSel.data || null);

      // 3) INSERT teste em trades (para pegar erro de sequence/RLS)
      const today = new Date().toISOString().slice(0,10);
      const tIns = await sb.from('trades').insert({
        user_id: uid, trade_date: today, pair: 'TESTUSDT',
        position: 'long', value_trade: 1, type: 'profit', percent: 1, result: 0.01, new_value: 1.01,
        observations: '__diagnostic__'
      }).select().single();
      log(p, '\ntrades INSERT -> status:', tIns.status || null);
      log(p, 'trades.insert.error:', tIns.error || null);
      log(p, 'trades.insert.data:', tIns.data || null);

      // Limpando o registro de teste
      if (tIns.data && tIns.data.id) {
        const del = await sb.from('trades').delete().eq('id', tIns.data.id);
        log(p, 'cleanup delete.error:', del.error || null);
      }
      p.status.textContent = ' pronto';
    } catch (e) {
      log(p, '\nexception:', e && (e.message || e));
      p.status.textContent = ' com erro';
    }
  }

  const btn = document.createElement('button');
  btn.textContent = 'üîé Diagn√≥stico';
  btn.title = 'Executa testes de SELECT/INSERT no Supabase';
  btn.className = 'btn btn-warning';
  Object.assign(btn.style, {position:'fixed',bottom:'14px',left:'14px',zIndex:99998});
  btn.onclick = run;
  window.addEventListener('load', ()=> document.body.appendChild(btn));
})();
</script>

</body>
</html>
