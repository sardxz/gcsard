<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trading Tracker ‚Äî Sistema Corrigido</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* === RESET E VARI√ÅVEIS CSS === */
    :root {
      --primary-color: #10b981;
      --primary-dark: #059669;
      --secondary-color: #2563eb;
      --success-color: #16a34a;
      --danger-color: #dc2626;
      --warning-color: #f59e0b;
      --info-color: #3b82f6;
      --light-bg: #f8f9ff;
      --white: #ffffff;
      --gray-100: #f1f5f9;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --border-radius: 8px;
      --border-radius-lg: 12px;
      --transition: all 0.2s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    /* === CONTAINER PRINCIPAL === */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 15px;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      position: relative;
    }

    /* === CABE√áALHO === */
    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: var(--white);
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2.2em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    /* === STATUS E AUTENTICA√á√ÉO === */
    .cloud-status {
      position: absolute;
      top: 20px;
      right: 30px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
      backdrop-filter: blur(10px);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger-color);
      animation: pulse 2s infinite;
    }

    .status-dot.online {
      background: var(--success-color);
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .auth-bar {
      position: absolute;
      left: 30px;
      top: 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 16px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .auth-bar small {
      opacity: 0.9;
      font-weight: 500;
    }

    /* === GRID DE ESTAT√çSTICAS === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      padding: 30px;
      background: var(--light-bg);
    }

    .stat-card {
      background: var(--white);
      padding: 24px;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      text-align: center;
      border-left: 5px solid var(--primary-color);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card h3 {
      color: var(--primary-color);
      font-size: 0.9em;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .stat-card .value {
      font-size: 1.8em;
      font-weight: 700;
      color: var(--gray-900);
    }

    /* === CONFIGURA√á√ïES === */
    .settings {
      padding: 28px;
      background: var(--gray-100);
      border-bottom: 1px solid var(--gray-200);
      border-radius: 0;
    }

    .settings h2 {
      color: var(--gray-700);
      margin-bottom: 20px;
      font-size: 1.3em;
      font-weight: 600;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    /* === CONTROLES === */
    .controls {
      padding: 28px;
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
    }

    .controls h2 {
      color: var(--gray-700);
      margin-bottom: 20px;
      font-size: 1.3em;
      font-weight: 600;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .form-group label {
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--gray-700);
      font-size: 0.9em;
    }

    .form-group label.required::after {
      content: ' *';
      color: var(--danger-color);
      font-weight: bold;
    }

    .form-group input,
    .form-group select {
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: var(--transition);
      background: var(--white);
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .form-group input:invalid {
      border-color: var(--danger-color);
    }

    .form-group .error-message {
      color: var(--danger-color);
      font-size: 0.8em;
      margin-top: 4px;
      opacity: 0;
      transition: var(--transition);
    }

    .form-group.has-error .error-message {
      opacity: 1;
    }

    .form-group.has-error input,
    .form-group.has-error select {
      border-color: var(--danger-color);
    }

    /* === BOT√ïES === */
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      margin-right: 8px;
      margin-bottom: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: var(--white);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--secondary-color) 0%, var(--info-color) 100%);
      color: var(--white);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color) 0%, #f97316 100%);
      color: var(--white);
    }

    .btn-secondary {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning-color) 0%, #f59e0b 100%);
      color: var(--white);
    }

    /* === LOADING STATES === */
    .loading {
      position: relative;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* === TABELA === */
    .table-container {
      padding: 28px;
      overflow-x: auto;
      position: relative;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .table-header h2 {
      color: var(--gray-700);
      font-size: 1.3em;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }

    th {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: var(--white);
      padding: 16px 12px;
      font-weight: 700;
      text-align: left;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 16px 12px;
      border-bottom: 1px solid var(--gray-200);
      white-space: nowrap;
      vertical-align: middle;
    }

    tr:hover {
      background: var(--light-bg);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .profit {
      color: var(--success-color);
      font-weight: 700;
    }

    .loss {
      color: var(--danger-color);
      font-weight: 700;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-500);
    }

    .empty-state h3 {
      font-size: 1.5em;
      margin-bottom: 12px;
      color: var(--gray-700);
    }

    .empty-state p {
      font-size: 1.1em;
      margin-bottom: 20px;
    }

    /* === NOTIFICA√á√ïES === */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: var(--border-radius);
      color: var(--white);
      font-weight: 600;
      z-index: 9999;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: linear-gradient(135deg, var(--success-color) 0%, #34d399 100%);
    }

    .notification.error {
      background: linear-gradient(135deg, var(--danger-color) 0%, #f97316 100%);
    }

    .notification.info {
      background: linear-gradient(135deg, var(--info-color) 0%, #3b82f6 100%);
    }

    .notification.warning {
      background: linear-gradient(135deg, var(--warning-color) 0%, #f59e0b 100%);
    }

    /* === MODAL DE AUTENTICA√á√ÉO === */
    .auth-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 8000;
      backdrop-filter: blur(5px);
    }

    .auth-card {
      background: var(--white);
      padding: 0;
      border-radius: var(--border-radius-lg);
      min-width: 400px;
      max-width: 500px;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      transform: scale(0.9);
      transition: transform 0.2s ease;
    }

    .auth-modal.show .auth-card {
      transform: scale(1);
    }

    .auth-tabs {
      display: flex;
      background: var(--gray-100);
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 16px 0;
      font-weight: 700;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
    }

    .auth-tab:hover {
      background: var(--gray-200);
    }

    .auth-tab.active {
      background: var(--white);
      border-bottom-color: var(--primary-color);
    }

    .auth-body {
      padding: 30px;
    }

    .auth-body h3 {
      margin-bottom: 20px;
      color: var(--gray-700);
      text-align: center;
      font-size: 1.3em;
    }

    .auth-row {
      margin-bottom: 16px;
    }

    .auth-row input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: var(--transition);
    }

    .auth-row input:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .auth-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .auth-hint {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 12px;
      text-align: center;
      line-height: 1.4;
    }

    /* === RESPONSIVIDADE === */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        border-radius: 10px;
      }

      .header {
        padding: 20px;
        text-align: left;
      }

      .header h1 {
        font-size: 1.6em;
      }

      .stats-grid,
      .settings,
      .controls,
      .table-container {
        padding: 20px;
      }

      .auth-bar {
        position: relative;
        left: 0;
        top: 0;
        margin-bottom: 12px;
        justify-content: flex-start;
      }

      .cloud-status {
        position: relative;
        top: 0;
        right: 0;
        margin-top: 12px;
        justify-content: flex-start;
      }

      .auth-card {
        min-width: 320px;
        margin: 20px;
      }

      .form-grid,
      .settings-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .table-container {
        padding: 15px;
      }

      table {
        font-size: 14px;
      }

      th, td {
        padding: 12px 8px;
      }
    }

    /* === ACESSIBILIDADE === */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* === FOCUS VISIBLE === */
    .btn:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <!-- === CONTAINER PRINCIPAL === -->
  <div class="container">
    
    <!-- === CABE√áALHO COM AUTENTICA√á√ÉO E STATUS === -->
    <div class="header">
      <div class="auth-bar">
        <small id="whoami" aria-label="Status do usu√°rio">Carregando...</small>
        <button class="btn btn-secondary" id="btnLogin" aria-label="Fazer login">
          <span>üîê</span> Entrar
        </button>
        <button class="btn btn-secondary" id="btnLogout" style="display:none" aria-label="Fazer logout">
          <span>üö™</span> Sair
        </button>
      </div>
      
      <div class="cloud-status" role="status" aria-live="polite">
        <div class="status-dot" id="statusDot" aria-hidden="true"></div>
        <span id="cloudStatus">Conectando...</span>
      </div>
      
      <h1>üìà Trading Tracker</h1>
      <p>Sistema Avan√ßado de Rastreamento de Trades</p>
    </div>

    <!-- === SE√á√ÉO DE CONFIGURA√á√ïES GERAIS === -->
    <div class="settings">
      <h2>‚öôÔ∏è Configura√ß√µes da Conta</h2>
      <div class="settings-grid">
        <div class="form-group">
          <label for="bankInitial" class="required">Banca Inicial (USDT)</label>
          <input type="number" id="bankInitial" step="0.01" placeholder="ex: 59000" required />
          <div class="error-message" id="bankInitial-error"></div>
          <small>Valor total da sua banca para trading</small>
        </div>
        
        <div class="form-group">
          <label for="initialTrade" class="required">Valor 1¬∫ Trade (USDT)</label>
          <input type="number" id="initialTrade" step="0.01" placeholder="ex: 2360" required />
          <div class="error-message" id="initialTrade-error"></div>
          <small>Valor do primeiro trade da sua estrat√©gia</small>
        </div>
        
        <div class="form-group">
          <label for="percentTarget" class="required">Percentual Alvo por Trade (%)</label>
          <input type="number" id="percentTarget" step="0.01" placeholder="ex: 12" required />
          <div class="error-message" id="percentTarget-error"></div>
          <small>Meta de lucro/preju√≠zo por opera√ß√£o</small>
        </div>
        
        <div style="display:flex;align-items:flex-end;gap:12px">
          <button class="btn btn-success" id="saveSettings" aria-label="Salvar configura√ß√µes">
            <span>üíæ</span> Salvar Configura√ß√µes
          </button>
        </div>
      </div>
    </div>

    <!-- === GRID DE ESTAT√çSTICAS E M√âTRICAS === -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Banca Total</h3>
        <div class="value" id="totalBalance">$0.00</div>
      </div>
      
      <div class="stat-card">
        <h3>Pr√≥ximo Trade</h3>
        <div class="value" id="nextTradeValue">$0.00</div>
      </div>
      
      <div class="stat-card">
        <h3>Total de Trades</h3>
        <div class="value" id="totalTrades">0</div>
      </div>
      
      <div class="stat-card">
        <h3>Win Rate</h3>
        <div class="value" id="winRate">0%</div>
      </div>
      
      <div class="stat-card">
        <h3>Lucro Acumulado</h3>
        <div class="value profit" id="totalProfit">$0.00</div>
      </div>
      
      <div class="stat-card">
        <h3>ROI (sobre banca)</h3>
        <div class="value" id="totalROI">0%</div>
      </div>
    </div>

    <!-- === CONTROLES PARA ADICIONAR TRADES === -->
    <div class="controls">
      <h2>üìù Registrar Novo Trade</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="tradeDate" class="required">Data do Trade</label>
          <input type="date" id="tradeDate" required />
          <div class="error-message" id="tradeDate-error"></div>
        </div>
        
        <div class="form-group">
          <label for="pair" class="required">Paridade</label>
          <input type="text" id="pair" placeholder="ex: BTCUSDT" required />
          <div class="error-message" id="pair-error"></div>
        </div>
        
        <div class="form-group">
          <label for="tradeValue">Valor do Trade (calculado)</label>
          <input type="number" id="tradeValue" step="0.01" readonly />
        </div>
        
        <div class="form-group">
          <label for="position" class="required">Tipo de Posi√ß√£o</label>
          <select id="position" required>
            <option value="">Selecione...</option>
            <option value="long">LONG (Compra)</option>
            <option value="short">SHORT (Venda)</option>
          </select>
          <div class="error-message" id="position-error"></div>
        </div>
        
        <div class="form-group">
          <label for="resultType" class="required">Resultado</label>
          <select id="resultType" required>
            <option value="">Selecione...</option>
            <option value="profit">Lucro</option>
            <option value="loss">Preju√≠zo</option>
          </select>
          <div class="error-message" id="resultType-error"></div>
        </div>
        
        <div class="form-group">
          <label for="percentage" class="required">Percentual (%)</label>
          <input type="number" id="percentage" step="0.01" required min="0" max="100" />
          <div class="error-message" id="percentage-error"></div>
        </div>
        
        <div class="form-group">
          <label for="observations">Observa√ß√µes</label>
          <input type="text" id="observations" placeholder="Setup, estrat√©gia, etc." maxlength="200" />
        </div>
      </div>
      
      <div>
        <button class="btn btn-primary" id="addTradeBtn">
          <span>‚ûï</span> Adicionar Trade
        </button>
        <button class="btn btn-success" id="exportBtn">
          <span>üìä</span> Exportar CSV
        </button>
        <button class="btn btn-danger" id="resetBtn">
          <span>‚ôªÔ∏è</span> Resetar Tudo
        </button>
      </div>
    </div>

    <!-- === SE√á√ÉO DA TABELA DE TRADES === -->
    <div class="table-container">
      <div class="table-header">
        <h2>üìã Hist√≥rico de Trades</h2>
      </div>
      
      <div class="table-wrapper">
        <table id="tradesTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Paridade</th>
              <th>Valor Trade</th>
              <th>Tipo</th>
              <th>Resultado</th>
              <th>PNL (%)</th>
              <th>PNL ($)</th>
              <th>Novo Valor</th>
              <th>Observa√ß√µes</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tradesBody">
            <!-- Trades ser√£o inseridos aqui dinamicamente -->
          </tbody>
        </table>
        
        <!-- Estado vazio da tabela -->
        <div class="empty-state" id="emptyState" style="display: none;">
          <h3>üìà Nenhum trade registrado</h3>
          <p>Adicione seu primeiro trade para come√ßar a acompanhar sua performance!</p>
          <button class="btn btn-primary" onclick="document.getElementById('tradeDate').focus()">
            <span>‚ûï</span> Adicionar Primeiro Trade
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- === MODAL DE AUTENTICA√á√ÉO === -->
  <div class="auth-modal" id="authModal">
    <div class="auth-card">
      <div class="auth-tabs">
        <div class="auth-tab active" id="tabSignup">CADASTRO</div>
        <div class="auth-tab" id="tabLogin">LOGIN</div>
      </div>
      
      <!-- Painel de Cadastro -->
      <div class="auth-body" id="bodySignup">
        <h3>Criar Nova Conta</h3>
        <div class="auth-row">
          <input type="email" id="signupEmail" placeholder="seu@email.com" required />
        </div>
        <div class="auth-row">
          <input type="text" id="signupUsername" placeholder="nome_de_usuario" required />
        </div>
        <div class="auth-row">
          <input type="password" id="signupPassword" placeholder="senha segura" required />
        </div>
        <div class="auth-actions">
          <button class="btn btn-secondary" id="closeAuth1">Cancelar</button>
          <button class="btn btn-primary" id="doLogin">
            <span>üîê</span> Entrar
          </button>
        </div>
        <div class="auth-hint">
          Entre com seu <strong>nome de usu√°rio</strong> e senha.<br>
          Esqueceu a senha? Entre em contato com o suporte.
        </div>
      </div>
    </div>
  </div>

  <!-- === SCRIPTS === -->
  <script>
    // ======= CONFIGURE AQUI AS CREDENCIAIS DO SUPABASE =======
    const SUPABASE_URL = 'https://ayoltukjvrpcwumsauan.supabase.co'; // <-- Substitua pela sua URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5b2x0dWtqdnJwY3d1bXNhdWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDUwMTQsImV4cCI6MjA3MTYyMTAxNH0.pCQouhf6ZazBjSIArOmWPdF4HOmh1r_L4NLzrTm7bmE';               // <-- Substitua pela sua chave
    // =========================================================

    // === CLASSE PRINCIPAL DO TRADING TRACKER ===
    class TradingTracker {
      constructor() {
        this.sb = null;
        this.state = {
          user: null,
          trades: [],
          initialBalance: 0,
          initialTradeValue: 0,
          percentTarget: 0,
          currentTradeValue: 0,
          profileUsername: '',
          isLoading: false
        };
        
        this.debounceTimers = {};
        this.init();
      }

      // === INICIALIZA√á√ÉO ROBUSTA ===
      async init() {
        try {
          console.log('üöÄ Inicializando Trading Tracker...');
          
          // Verificar se as credenciais foram configuradas
          if (SUPABASE_URL === 'https://YOUR-PROJECT.supabase.co' || SUPABASE_ANON_KEY === 'YOUR-ANON-KEY') {
            this.showNotification('Configure as credenciais do Supabase no c√≥digo!', 'error');
            this.setConnectionStatus(false);
            return;
          }

          // Inicializar Supabase
          this.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          
          // Configurar listeners
          this.setupEventListeners();
          this.setupAuthListeners();
          
          // Inicializar sess√£o
          await this.initSession();
          
          // Configurar data padr√£o
          this.setDefaultDate();
          
          console.log('‚úÖ Trading Tracker inicializado com sucesso');
          
        } catch (error) {
          console.error('‚ùå Erro na inicializa√ß√£o:', error);
          this.showNotification('Erro na inicializa√ß√£o: ' + error.message, 'error');
          this.setConnectionStatus(false);
        }
      }

      // === CONFIGURAR EVENT LISTENERS ===
      setupEventListeners() {
        // Autentica√ß√£o
        document.getElementById('btnLogin').onclick = () => this.openAuthModal('login');
        document.getElementById('btnLogout').onclick = () => this.logout();
        document.getElementById('closeAuth1').onclick = () => this.closeAuthModal();
        document.getElementById('closeAuth2').onclick = () => this.closeAuthModal();
        document.getElementById('doSignup').onclick = () => this.signup();
        document.getElementById('doLogin').onclick = () => this.login();

        // Abas do modal
        document.getElementById('tabSignup').onclick = () => this.switchAuthTab('signup');
        document.getElementById('tabLogin').onclick = () => this.switchAuthTab('login');

        // Configura√ß√µes e trades
        document.getElementById('saveSettings').onclick = () => this.saveSettings();
        document.getElementById('addTradeBtn').onclick = () => this.addTrade();
        document.getElementById('exportBtn').onclick = () => this.exportCSV();
        document.getElementById('resetBtn').onclick = () => this.resetAll();

        // Fechar modal ao clicar fora
        document.getElementById('authModal').onclick = (e) => {
          if (e.target === e.currentTarget) {
            this.closeAuthModal();
          }
        };

        // ESC para fechar modal
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            this.closeAuthModal();
          }
        });
      }

      // === CONFIGURAR LISTENERS DE AUTENTICA√á√ÉO ===
      setupAuthListeners() {
        this.sb.auth.onAuthStateChange(async (event, session) => {
          console.log('üîê Auth state changed:', event);
          
          try {
            if (event === 'SIGNED_IN' && session?.user) {
              this.state.user = session.user;
              await this.loadEverything();
              this.toggleAuth(true);
              this.showNotification('Login realizado com sucesso!', 'success');
            } else if (event === 'SIGNED_OUT') {
              this.handleSignOut();
            } else if (event === 'TOKEN_REFRESHED') {
              console.log('üîÑ Token atualizado');
            }
          } catch (error) {
            console.error('Erro no listener de auth:', error);
            this.showNotification('Erro na autentica√ß√£o: ' + error.message, 'error');
          }
        });
      }

      // === INICIALIZA√á√ÉO DE SESS√ÉO CORRIGIDA ===
      async initSession() {
        this.setLoadingState(true);
        
        try {
          const { data: { session }, error } = await this.sb.auth.getSession();
          
          if (error) {
            console.error('Erro ao obter sess√£o:', error);
            this.setConnectionStatus(false);
            this.setWhoAmI('Deslogado');
            return;
          }

          this.state.user = session?.user || null;
          
          if (this.state.user) {
            await this.loadEverything();
            this.toggleAuth(true);
          } else {
            this.toggleAuth(false);
            this.setDefaultValues();
          }
          
          this.setConnectionStatus(!!this.state.user);
          
        } catch (error) {
          console.error('Erro na inicializa√ß√£o da sess√£o:', error);
          this.showNotification('Erro na conex√£o com o servidor', 'error');
          this.setConnectionStatus(false);
          this.setWhoAmI('Erro na conex√£o');
        } finally {
          this.setLoadingState(false);
        }
      }

      // === CARREGAR TODOS OS DADOS COM TRATAMENTO DE ERRO ===
      async loadEverything() {
        if (!this.state.user) return;

        this.setLoadingState(true);

        try {
          // Carregar perfil
          const profile = await this.ensureProfile();
          
          this.state.initialBalance = Number(profile.bank_initial || 0);
          this.state.initialTradeValue = Number(profile.initial_trade_value || 0);
          this.state.percentTarget = Number(profile.percent_target || 0);
          this.state.profileUsername = profile.username || '';

          this.setWhoAmI(this.state.profileUsername || this.state.user?.email || 'Usu√°rio');

          // Atualizar campos
          document.getElementById('bankInitial').value = this.state.initialBalance || '';
          document.getElementById('initialTrade').value = this.state.initialTradeValue || '';
          document.getElementById('percentTarget').value = this.state.percentTarget || '';

          // Carregar trades com retry
          await this.loadTradesWithRetry();

          // Calcular valor atual
          this.updateCurrentTradeValue();

          // Definir valores padr√£o
          document.getElementById('percentage').value = this.state.percentTarget || 12;
          document.getElementById('tradeValue').value = (this.state.currentTradeValue || 0).toFixed(2);

          // Renderizar
          this.render();

        } catch (error) {
          console.error('Erro ao carregar dados:', error);
          this.showNotification('Erro ao carregar dados: ' + error.message, 'error');
        } finally {
          this.setLoadingState(false);
        }
      }

      // === CARREGAR TRADES COM RETRY ===
      async loadTradesWithRetry(maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            const { data: trades, error } = await this.sb
              .from('trades')
              .select('*')
              .eq('user_id', this.state.user.id)
              .order('trade_date', { ascending: true });

            if (error) {
              throw error;
            }

            this.state.trades = trades || [];
            console.log(`‚úÖ Trades carregados: ${this.state.trades.length}`);
            return;

          } catch (error) {
            console.error(`Tentativa ${attempt} de carregar trades falhou:`, error);
            
            if (attempt === maxRetries) {
              this.state.trades = [];
              this.showNotification('N√£o foi poss√≠vel carregar os trades. Tente recarregar a p√°gina.', 'error');
            } else {
              // Aguardar antes da pr√≥xima tentativa
              await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
          }
        }
      }

      // === GARANTIR PERFIL COM TRATAMENTO ROBUSTO ===
      async ensureProfile() {
        try {
          const { data: profile, error } = await this.sb
            .from('profiles')
            .select('*')
            .eq('id', this.state.user.id)
            .single();

          if (error && error.code === 'PGRST116') {
            // Perfil n√£o existe, criar um
            const defaultProfile = {
              id: this.state.user.id,
              email: this.state.user.email || null,
              username: null,
              bank_initial: 59000,
              initial_trade_value: 2360,
              percent_target: 12
            };

            const { data: newProfile, error: createError } = await this.sb
              .from('profiles')
              .insert(defaultProfile)
              .select()
              .single();

            if (createError) {
              throw createError;
            }

            return newProfile;
          }

          if (error) {
            throw error;
          }

          return profile;

        } catch (error) {
          console.error('Erro no perfil:', error);
          
          // Retornar perfil padr√£o em caso de erro
          return {
            id: this.state.user.id,
            email: this.state.user.email || null,
            username: null,
            bank_initial: 59000,
            initial_trade_value: 2360,
            percent_target: 12
          };
        }
      }

      // === LOGOUT CORRIGIDO ===
      async logout() {
        if (!confirm('Deseja realmente sair da sua conta?')) {
          return;
        }

        this.setLoadingState(true);

        try {
          const { error } = await this.sb.auth.signOut();
          if (error) {
            throw error;
          }
          
          // O listener autom√°tico vai chamar handleSignOut()
          
        } catch (error) {
          console.error('Erro no logout:', error);
          this.showNotification('Erro ao fazer logout: ' + error.message, 'error');
          
          // For√ßar logout local em caso de erro
          this.handleSignOut();
        } finally {
          this.setLoadingState(false);
        }
      }

      // === TRATAR SIGN OUT ===
      handleSignOut() {
        this.state.user = null;
        this.state.trades = [];
        this.state.profileUsername = '';
        
        this.toggleAuth(false);
        this.setDefaultValues();
        this.render();
        
        this.showNotification('Logout realizado', 'info');
      }

      // === SISTEMA DE LOADING ===
      setLoadingState(isLoading) {
        this.state.isLoading = isLoading;
        
        const buttons = document.querySelectorAll('.btn');
        buttons.forEach(btn => {
          if (isLoading) {
            btn.classList.add('loading');
            btn.disabled = true;
          } else {
            btn.classList.remove('loading');
            btn.disabled = false;
          }
        });
      }

      // === TOGGLE DE AUTENTICA√á√ÉO ===
      toggleAuth(isLogged) {
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        
        btnLogin.style.display = isLogged ? 'none' : 'inline-flex';
        btnLogout.style.display = isLogged ? 'inline-flex' : 'none';
        
        this.setWhoAmI(isLogged ? (this.state.profileUsername || this.state.user?.email || 'Usu√°rio') : 'Deslogado');
        this.setConnectionStatus(isLogged);
      }

      // === DEFINIR STATUS DE USU√ÅRIO ===
      setWhoAmI(name) {
        document.getElementById('whoami').textContent = name || 'Deslogado';
      }

      // === DEFINIR STATUS DE CONEX√ÉO ===
      setConnectionStatus(online) {
        const dot = document.getElementById('statusDot');
        const txt = document.getElementById('cloudStatus');
        
        if (online) {
          dot.classList.add('online');
          txt.textContent = 'Online';
        } else {
          dot.classList.remove('online');
          txt.textContent = 'Offline';
        }
      }

      // === MODAL DE AUTENTICA√á√ÉO ===
      openAuthModal(tab = 'login') {
        this.switchAuthTab(tab);
        const modal = document.getElementById('authModal');
        modal.style.display = 'flex';
        modal.classList.add('show');
        
        setTimeout(() => {
          const firstInput = modal.querySelector('input');
          if (firstInput) firstInput.focus();
        }, 100);
      }

      closeAuthModal() {
        const modal = document.getElementById('authModal');
        modal.classList.remove('show');
        
        setTimeout(() => {
          modal.style.display = 'none';
          this.clearAuthForms();
        }, 200);
      }

      switchAuthTab(tab) {
        const tabSignup = document.getElementById('tabSignup');
        const tabLogin = document.getElementById('tabLogin');
        const bodySignup = document.getElementById('bodySignup');
        const bodyLogin = document.getElementById('bodyLogin');

        if (tab === 'signup') {
          tabSignup.classList.add('active');
          tabLogin.classList.remove('active');
          bodySignup.style.display = 'block';
          bodyLogin.style.display = 'none';
        } else {
          tabLogin.classList.add('active');
          tabSignup.classList.remove('active');
          bodyLogin.style.display = 'block';
          bodySignup.style.display = 'none';
        }
      }

      clearAuthForms() {
        ['signupEmail', 'signupUsername', 'signupPassword', 'loginUsername', 'loginPassword']
          .forEach(id => {
            const input = document.getElementById(id);
            if (input) input.value = '';
          });
      }

      // === CADASTRO ===
      async signup() {
        const email = document.getElementById('signupEmail').value.trim();
        const username = document.getElementById('signupUsername').value.trim();
        const password = document.getElementById('signupPassword').value.trim();

        if (!email || !username || !password) {
          this.showNotification('Preencha todos os campos', 'error');
          return;
        }

        if (password.length < 6) {
          this.showNotification('Senha deve ter pelo menos 6 caracteres', 'error');
          return;
        }

        this.setLoadingState(true);

        try {
          const { data: signUpData, error: signUpError } = await this.sb.auth.signUp({
            email,
            password
          });

          if (signUpError) {
            throw signUpError;
          }

          const authUserId = signUpData.user?.id;
          if (!authUserId) {
            this.showNotification('Cadastro criado. Confirme seu e-mail se necess√°rio.', 'info');
            return;
          }

          // Criar perfil
          const { error: profileError } = await this.sb
            .from('profiles')
            .insert({
              id: authUserId,
              email: email,
              username: username,
              bank_initial: 59000,
              initial_trade_value: 2360,
              percent_target: 12
            });

          if (profileError && !profileError.message.includes('duplicate')) {
            console.error('Erro no perfil:', profileError);
          }

          // Tentar login autom√°tico
          const { error: loginError } = await this.sb.auth.signInWithPassword({
            email,
            password
          });

          if (loginError) {
            this.showNotification('Conta criada! Fa√ßa login agora.', 'success');
            this.switchAuthTab('login');
          } else {
            this.closeAuthModal();
            this.showNotification('Cadastro e login realizados!', 'success');
          }

        } catch (error) {
          console.error('Erro no cadastro:', error);
          this.showNotification(this.getErrorMessage(error), 'error');
        } finally {
          this.setLoadingState(false);
        }
      }

      // === LOGIN ===
      async login() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value.trim();

        if (!username || !password) {
          this.showNotification('Preencha usu√°rio e senha', 'error');
          return;
        }

        this.setLoadingState(true);

        try {
          // Buscar email pelo username
          let email = null;
          
          try {
            const { data: rpcData, error: rpcError } = await this.sb.rpc('get_email_by_username', {
              p_username: username
            });

            if (rpcError) {
              throw rpcError;
            }
            
            email = rpcData;
          } catch (rpcError) {
            // Se a fun√ß√£o RPC n√£o existir, tentar login direto com username
            if (username.includes('@')) {
              email = username;
            } else {
              this.showNotification('Fun√ß√£o de busca n√£o configurada. Use e-mail para login.', 'error');
              return;
            }
          }

          if (!email) {
            this.showNotification('Usu√°rio n√£o encontrado', 'error');
            return;
          }

          // Fazer login
          const { error: loginError } = await this.sb.auth.signInWithPassword({
            email,
            password
          });

          if (loginError) {
            throw loginError;
          }

          this.closeAuthModal();

        } catch (error) {
          console.error('Erro no login:', error);
          this.showNotification(this.getErrorMessage(error), 'error');
        } finally {
          this.setLoadingState(false);
        }
      }

      // === SALVAR CONFIGURA√á√ïES ===
      async saveSettings() {
        if (!this.state.user) {
          this.showNotification('Fa√ßa login para salvar', 'error');
          return;
        }

        const bank = Number(document.getElementById('bankInitial').value || 0);
        const initValue = Number(document.getElementById('initialTrade').value || 0);
        const percent = Number(document.getElementById('percentTarget').value || 0);

        if (bank <= 0 || initValue <= 0 || percent <= 0) {
          this.showNotification('Valores devem ser maiores que zero', 'error');
          return;
        }

        this.setLoadingState(true);

        try {
          const { error } = await this.sb
            .from('profiles')
            .upsert({
              id: this.state.user.id,
              bank_initial: bank,
              initial_trade_value: initValue,
              percent_target: percent
            });

          if (error) {
            throw error;
          }

          this.state.initialBalance = bank;
          this.state.initialTradeValue = initValue;
          this.state.percentTarget = percent;

          if (this.state.trades.length === 0) {
            this.state.currentTradeValue = this.state.initialTradeValue;
            document.getElementById('tradeValue').value = this.state.currentTradeValue.toFixed(2);
          }

          this.render();
          this.showNotification('Configura√ß√µes salvas!', 'success');

        } catch (error) {
          console.error('Erro ao salvar:', error);
          this.showNotification('Erro ao salvar: ' + error.message, 'error');
        } finally {
          this.setLoadingState(false);
        }
      }

      // === ADICIONAR TRADE ===
      async addTrade() {
        if (!this.state.user) {
          this.showNotification('Fa√ßa login para adicionar trades', 'error');
          return;
        }

        const date = document.getElementById('tradeDate').value;
        const pair = document.getElementById('pair').value.trim().toUpperCase();
        const value = Number(document.getElementById('tradeValue').value);
        const position = document.getElementById('position').value;
        const type = document.getElementById('resultType').value;
        const percent = Number(document.getElementById('percentage').value);
        const observations = document.getElementById('observations').value.trim();

        if (!date || !pair || !position || !type || !percent) {
          this.showNotification('Preencha todos os campos obrigat√≥rios', 'error');
          return;
        }

        if (percent <= 0) {
          this.showNotification('Percentual deve ser maior que zero', 'error');
          return;
        }

        this.setLoadingState(true);

        try {
          const resultAbs = +(value * (percent / 100)).toFixed(2);
          const result = type === 'profit' ? resultAbs : -resultAbs;
          const newValue = +(value + result).toFixed(2);

          const payload = {
            user_id: this.state.user.id,
            trade_date: date,
            pair: pair,
            position: position,
            value_trade: value,
            type: type,
            percent: percent,
            result: result,
            new_value: newValue,
            observations: observations
          };

          const { data, error } = await this.sb
            .from('trades')
            .insert(payload)
            .select()
            .single();

          if (error) {
            throw error;
          }

          this.state.trades.push(data);
          this.state.currentTradeValue = newValue;
          document.getElementById('tradeValue').value = newValue.toFixed(2);

          this.clearTradeForm();
          this.render();
          this.showNotification('Trade adicionado!', 'success');

        } catch (error) {
          console.error('Erro ao adicionar trade:', error);
          this.showNotification('Erro ao adicionar trade: ' + error.message, 'error');
        } finally {
          this.setLoadingState(false);
        }
      }

      // === ATUALIZAR VALOR DO TRADE ATUAL ===
      updateCurrentTradeValue() {
        if (this.state.trades.length > 0) {
          const lastTrade = this.state.trades[this.state.trades.length - 1];
          this.state.currentTradeValue = Number(lastTrade.new_value);
        } else {
          this.state.currentTradeValue = this.state.initialTradeValue;
        }
      }

      // === LIMPAR FORMUL√ÅRIO ===
      clearTradeForm() {
        document.getElementById('pair').value = '';
        document.getElementById('position').value = '';
        document.getElementById('resultType').value = '';
        document.getElementById('percentage').value = this.state.percentTarget || 12;
        document.getElementById('observations').value = '';
      }

      // === REMOVER TRADE ===
      async removeTrade(tradeId) {
        if (!confirm('Remover este trade?')) return;

        this.setLoadingState(true);

        try {
          const { error } = await this.sb
            .from('trades')
            .delete()
            .eq('id', tradeId)
            .eq('user_id', this.state.user.id);

          if (error) {
            throw error;
          }

          this.state.trades = this.state.trades.filter(t => t.id !== tradeId);
          this.updateCurrentTradeValue();
          document.getElementById('tradeValue').value = (this.state.currentTradeValue || 0).toFixed(2);
          this.render();
          this.showNotification('Trade removido', 'success');

        } catch (error) {
          console.error('Erro ao remover:', error);
          this.showNotification('Erro ao remover trade', 'error');
        } finally {
          this.setLoadingState(false);
        }
      }

      // === EXPORTAR CSV ===
      exportCSV() {
        if (this.state.trades.length === 0) {
          this.showNotification('Nenhum trade para exportar', 'warning');
          return;
        }

        try {
          const headers = ['Data', 'Paridade', 'Valor Trade', 'Tipo', 'Resultado', 'PNL (%)', 'PNL ($)', 'Novo Valor', 'Observa√ß√µes'];
          const rows = this.state.trades.map(trade => {
            const signedPct = (trade.type === 'loss' ? -Number(trade.percent || 0) : Number(trade.percent || 0));
            return [
              trade.trade_date,
              trade.pair || '',
              trade.value_trade,
              (trade.position || '').toUpperCase(),
              trade.type === 'profit' ? 'Lucro' : 'Preju√≠zo',
              `${signedPct}%`,
              trade.result,
              trade.new_value,
              `"${(trade.observations || '').replace(/"/g, '""')}"`
            ];
          });

          const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `trades_${new Date().toISOString().slice(0, 10)}.csv`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          this.showNotification('Dados exportados!', 'success');

        } catch (error) {
          console.error('Erro na exporta√ß√£o:', error);
          this.showNotification('Erro ao exportar dados', 'error');
        }
      }

      // === RESETAR DADOS ===
      async resetAll() {
        if (!this.state.user) {
          this.showNotification('Fa√ßa login para resetar', 'error');
          return;
        }

        if (!confirm('ATEN√á√ÉO: Isso apagar√° TODOS os seus trades permanentemente!\n\nDeseja continuar?')) {
          return;
        }

        this.setLoadingState(true);

        try {
          const { error } = await this.sb
            .from('trades')
            .delete()
            .eq('user_id', this.state.user.id);

          if (error) {
            throw error;
          }

          this.state.trades = [];
          this.state.currentTradeValue = this.state.initialTradeValue;
          
          document.getElementById('tradeValue').value = this.state.currentTradeValue.toFixed(2);
          this.render();

          this.showNotification('Todos os dados foram apagados', 'success');

        } catch (error) {
          console.error('Erro ao resetar:', error);
          this.showNotification('Erro ao resetar dados', 'error');
        } finally {
          this.setLoadingState(false);
        }
      }

      // === RENDERIZA√á√ÉO ===
      render() {
        const stats = this.calculateStats();

        document.getElementById('totalTrades').textContent = stats.totalTrades;
        document.getElementById('winRate').textContent = this.formatPercent(stats.winRate);
        document.getElementById('totalProfit').textContent = this.formatMoney(stats.totalProfit);
        document.getElementById('totalROI').textContent = this.formatPercent(stats.totalROI);
        document.getElementById('nextTradeValue').textContent = this.formatMoney(stats.nextTradeValue);
        document.getElementById('totalBalance').textContent = this.formatMoney(stats.totalBalance);

        this.renderTable();
      }

      renderTable() {
        const tbody = document.getElementById('tradesBody');
        const emptyState = document.getElementById('emptyState');

        if (this.state.trades.length === 0) {
          tbody.innerHTML = '';
          emptyState.style.display = 'block';
          return;
        }

        emptyState.style.display = 'none';
        tbody.innerHTML = '';

        this.state.trades.forEach(trade => {
          const tr = document.createElement('tr');
          const signedPct = trade.type === 'loss' ? -Number(trade.percent || 0) : Number(trade.percent || 0);
          const resultClass = trade.type === 'profit' ? 'profit' : 'loss';

          tr.innerHTML = `
            <td>${this.formatDate(trade.trade_date)}</td>
            <td><strong>${trade.pair || ''}</strong></td>
            <td>${this.formatMoney(trade.value_trade)}</td>
            <td>${(trade.position || '').toUpperCase()}</td>
            <td><span class="${resultClass}">${trade.type === 'profit' ? 'Lucro' : 'Preju√≠zo'}</span></td>
            <td><strong>${signedPct.toFixed(2)}%</strong></td>
            <td class="${resultClass}"><strong>${this.formatMoney(trade.result)}</strong></td>
            <td>${this.formatMoney(trade.new_value)}</td>
            <td>${trade.observations || ''}</td>
            <td>
              <button class="btn btn-danger" onclick="app.removeTrade(${trade.id})" title="Remover trade">
                üóëÔ∏è
              </button>
            </td>
          `;

          tbody.appendChild(tr);
        });
      }

      // === C√ÅLCULOS E ESTAT√çSTICAS ===
      calculateStats() {
        const total = this.state.trades.length;
        if (total === 0) {
          return {
            totalTrades: 0,
            winRate: 0,
            totalProfit: 0,
            totalROI: 0,
            totalBalance: this.state.initialBalance,
      calculateStats() {
        const total = this.state.trades.length;
        if (total === 0) {
          return {
            totalTrades: 0,
            winRate: 0,
            totalProfit: 0,
            totalROI: 0,
            totalBalance: this.state.initialBalance,
            nextTradeValue: this.state.initialTradeValue
          };
        }

        const wins = this.state.trades.filter(t => t.type === 'profit').length;
        const winRate = (wins / total) * 100;
        const totalProfit = this.state.trades.reduce((sum, t) => sum + (t.result || 0), 0);
        const totalROI = this.state.initialBalance > 0 ? (totalProfit / this.state.initialBalance) * 100 : 0;
        const totalBalance = this.state.initialBalance - this.state.initialTradeValue + this.state.currentTradeValue + totalProfit;

        return {
          totalTrades: total,
          winRate: winRate,
          totalProfit: totalProfit,
          totalROI: totalROI,
          totalBalance: totalBalance,
          nextTradeValue: this.state.currentTradeValue
        };
      }

      // === UTILIT√ÅRIOS DE FORMATA√á√ÉO ===
      formatMoney(value) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(value || 0);
      }

      formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('pt-BR');
      }

      formatPercent(value, decimals = 1) {
        return `${Number(value || 0).toFixed(decimals)}%`;
      }

      // === SISTEMA DE NOTIFICA√á√ïES ===
      showNotification(message, type = 'success', duration = 4000) {
        // Remover notifica√ß√µes anteriores do mesmo tipo
        document.querySelectorAll(`.notification.${type}`).forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.1em;">${this.getNotificationIcon(type)}</span>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2em; margin-left: auto;">
              ‚úï
            </button>
          </div>
        `;

        document.body.appendChild(notification);

        // Animar entrada
        setTimeout(() => notification.classList.add('show'), 50);

        // Auto remover
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
        }, duration);
      }

      getNotificationIcon(type) {
        const icons = {
          success: '‚úÖ',
          error: '‚ùå', 
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è'
        };
        return icons[type] || '‚ÑπÔ∏è';
      }

      // === TRATAMENTO DE ERROS ===
      getErrorMessage(error) {
        const errorMessages = {
          'Invalid login credentials': 'Credenciais inv√°lidas. Verifique usu√°rio e senha.',
          'Email not confirmed': 'Confirme seu e-mail antes de fazer login.',
          'Too many requests': 'Muitas tentativas. Tente novamente em alguns minutos.',
          'User already registered': 'E-mail j√° cadastrado. Fa√ßa login ou use outro e-mail.',
          'Password should be at least 6 characters': 'Senha deve ter pelo menos 6 caracteres.',
          'Unable to validate email address': 'E-mail inv√°lido.',
          'signup_disabled': 'Cadastro de novos usu√°rios desabilitado.',
        };

        return errorMessages[error.message] || error.message || 'Erro desconhecido';
      }

      // === CONFIGURA√á√ïES PADR√ÉO ===
      setDefaultDate() {
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById('tradeDate').value = today;
      }

      setDefaultValues() {
        this.setDefaultDate();
        document.getElementById('percentage').value = 12;
        document.getElementById('tradeValue').value = '0.00';
      }
    }

    // === INICIALIZA√á√ÉO GLOBAL ===
    let app;

    // Aguardar DOM carregar
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Inicializando Trading Tracker...');
      app = new TradingTracker();
    });

    // Expor fun√ß√£o para HTML
    window.removeTrade = (tradeId) => {
      if (app) {
        app.removeTrade(tradeId);
      }
    };

    // === TRATAMENTO DE ERROS GLOBAIS ===
    window.addEventListener('error', (event) => {
      console.error('Erro global capturado:', event.error);
      if (app) {
        app.showNotification('Erro inesperado na aplica√ß√£o', 'error');
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Promise rejeitada:', event.reason);
      if (app) {
        app.showNotification('Erro de conex√£o. Verifique sua internet.', 'error');
      }
    });

    // === DETECTAR PERDA DE CONECTIVIDADE ===
    window.addEventListener('online', () => {
      if (app) {
        app.showNotification('Conex√£o restabelecida', 'success');
        // Tentar recarregar dados se o usu√°rio estiver logado
        if (app.state.user) {
          app.loadEverything();
        }
      }
    });

    window.addEventListener('offline', () => {
      if (app) {
        app.showNotification('Sem conex√£o com a internet', 'warning');
        app.setConnectionStatus(false);
      }
    });

    // === DETECTAR MUDAN√áA DE VISIBILIDADE (RETORNO √Ä P√ÅGINA) ===
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && app && app.state.user) {
        console.log('üîÑ P√°gina voltou ao foco, verificando sess√£o...');
        // Aguardar um pouco antes de tentar recarregar
        setTimeout(() => {
          app.initSession();
        }, 500);
      }
    });

    console.log('‚úÖ Sistema de Trading Tracker carregado e pronto!');
  </script>
</body>
</html>doSignup">
            <span>üöÄ</span> Cadastrar
          </button>
        </div>
        <div class="auth-hint">
          O <strong>nome de usu√°rio</strong> ser√° usado para fazer login.<br>
          Use letras, n√∫meros e underscore (3-20 caracteres).
        </div>
      </div>
      
      <!-- Painel de Login -->
      <div class="auth-body" id="bodyLogin" style="display:none">
        <h3>Entrar na Conta</h3>
        <div class="auth-row">
          <input type="text" id="loginUsername" placeholder="seu_nome_de_usuario" required />
        </div>
        <div class="auth-row">
          <input type="password" id="loginPassword" placeholder="sua senha" required />
        </div>
        <div class="auth-actions">
          <button class="btn btn-secondary" id="closeAuth2">Cancelar</button>
          <button class="btn btn-primary" id="
